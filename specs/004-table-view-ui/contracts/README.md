# Contracts: Slack Block Kit Table Format

**Feature**: Table View UI for Stale PR Board
**Date**: 2025-11-10

## Overview

This directory defines the contract (expected format) for Slack Block Kit table blocks generated by `SlackClient.build_blocks()`. These contracts serve as:

1. **API Specification**: Define the exact JSON structure sent to Slack webhook
2. **Test Fixtures**: Provide examples for unit test assertions
3. **Documentation**: Reference for developers understanding the table format

---

## Contract Files

### 1. [table-block-example-ko.json](./table-block-example-ko.json)

**Description**: Complete example of table block output in Korean language

**Usage**:
- Reference implementation for Korean translation
- Test fixture for bilingual support tests
- Sample for manual Slack Block Kit testing

### 2. [table-block-example-en.json](./table-block-example-en.json)

**Description**: Complete example of table block output in English language

**Usage**:
- Reference implementation for English translation
- Test fixture for bilingual support tests
- Default language sample

### 3. [empty-state-example.json](./empty-state-example.json)

**Description**: Empty state message when no PRs exist (bilingual examples)

**Usage**:
- Test fixture for empty state handling
- Reference for non-table fallback format

---

## Contract Guarantees

When `SlackClient.build_blocks()` is called, the output MUST:

### Structure Guarantees

1. **Return a list of Slack Block Kit blocks** (type: `list[dict]`)
2. **Include exactly 1 header block** with board title
3. **Include exactly 1 table block** when PRs exist
4. **Include optional context block** for truncation warning

### Table Block Guarantees

1. **Type**: `"table"`
2. **Column Settings**: Exactly 4 alignment configs
   - Columns 0-1: `{"align": "center"}`
   - Columns 2-3: `{"align": "left"}`
3. **Rows**: Array of row arrays
   - First row: Header row with 4 bold text cells
   - Subsequent rows: Data rows with 4 cells each
   - Maximum 100 rows (1 header + 99 data rows)

### Cell Format Guarantees

Each cell MUST be a `rich_text` block with:
- `"type": "rich_text"`
- `"elements"`: Array with exactly 1 `rich_text_section`
- `rich_text_section.elements`: Array of text/emoji/link/user elements

**Column 1 (Staleness)**:
- Exactly 1 emoji element
- Valid names: `"nauseated_face"`, `"cheese_wedge"`, `"sparkles"`

**Column 2 (Age)**:
- Exactly 1 text element
- Format: `\d+d` (e.g., "12d", "5d", "2d")

**Column 3 (PR Details)**:
- Exactly 2 elements:
  1. Text element with repo#number and newline
  2. Link element with PR title and GitHub URL

**Column 4 (Reviewers)**:
- N user elements interleaved with (N-1) newline text elements
- OR exactly 1 text element with value "-" when no reviewers

### Translation Guarantees

1. **Header text** MUST match configured language
2. **Column headers** MUST use correct translations:
   - EN: "Staleness", "Age", "PR", "Reviewers"
   - KO: "숙성도", "경과", "PR", "리뷰어"
3. **Empty state** MUST use correct translation
4. **Truncation warning** MUST use correct translation with `{count}` replaced

### Sorting Guarantee

1. Data rows MUST be sorted by `staleness_days` in **descending order** (stalest first)
2. Sorting happens **before** truncation

### Truncation Guarantee

1. If total PRs > `max_prs_total`, truncate to `min(max_prs_total, 99)` rows
2. Display context block warning with correct count of hidden PRs
3. Truncation preserves sorting order (keeps stalest PRs)

---

## Testing with Contracts

### Unit Test Pattern

```python
def test_build_blocks_generates_correct_table_structure():
    """Test that build_blocks() output matches contract."""
    # Arrange
    client = SlackClient(webhook_url="mock", language="en", max_prs_total=30)
    stale_prs = [create_mock_stale_pr(days=12, category="rotten")]
    team_members = [create_mock_team_member()]

    # Act
    blocks = client.build_blocks({"rotten": stale_prs, "aging": [], "fresh": []}, team_members)

    # Assert
    assert len(blocks) == 2  # header + table
    assert blocks[0]["type"] == "header"
    assert blocks[1]["type"] == "table"
    assert len(blocks[1]["column_settings"]) == 4
    assert len(blocks[1]["rows"]) == 2  # header + 1 data row
```

### Contract Validation

Use the example JSON files to validate output structure:

```python
import json

def validate_against_contract(blocks: list[dict], contract_path: str):
    """Validate blocks match contract structure."""
    with open(contract_path) as f:
        expected_structure = json.load(f)

    # Compare structure (ignoring data-specific values)
    assert_structure_matches(blocks, expected_structure)
```

---

## Slack Block Kit API Reference

**Official Documentation**: https://api.slack.com/reference/block-kit/blocks#table

**Key Constraints**:
- Maximum 20 columns per table
- Maximum 100 rows per table (including header)
- Table cells must use `rich_text` blocks (not `mrkdwn`)
- Alignment options: `"left"`, `"center"`, `"right"`

---

## Version History

- **v1.0.0** (2025-11-10): Initial contract definition for table view UI
